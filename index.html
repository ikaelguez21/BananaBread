<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BananaBread v24</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class', // This enables the manual toggle
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' } 
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        /* Custom Scrollbar - Light Mode */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Custom Scrollbar - Dark Mode */
        .dark .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        html, body { height: 100%; margin: 0; padding: 0; background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow-x: hidden; }
        
        /* Dark Mode Background for Body */
        html.dark body { background-color: #0f172a; }

        path.connection-line { 
            fill: none; 
            stroke-linecap: round;
            transition: stroke-opacity 0.3s, stroke-width 0.3s, stroke 0.3s;
            pointer-events: none;
        }

        /* Card Hover Animations */
        .course-card .action-bar { transform: translateY(100%); transition: transform 0.2s ease-out; }
        .course-card:hover .action-bar { transform: translateY(0); }
        
        .glass-dark { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); }
        .glass-dark-border { border-top: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

<div id="root" class="h-full flex flex-col transition-colors duration-200"></div>

<script type="text/babel">
    const { useState, useMemo, useEffect, useRef, useCallback, memo } = React;

    // --- ICONS ---
    const Icons = {
        Loader: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        Trash2: ({size=14}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
        Pencil: ({size=14}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
        AlertCircle: ({size=12, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
        Save: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
        Check: ({size=14, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className || "text-white"}><polyline points="20 6 9 17 4 12"/></svg>,
        PlusCircle: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>,
        Refresh: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
        GitBranch: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></svg>,
        Eye: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
        EyeOff: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>,
        ChevronDown: ({size=16, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>,
        ChevronUp: ({size=16, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>,
        Download: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
        Upload: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
        Fire: ({size=12}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="none" className="text-orange-500"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3.9.9 1.8 1.9 2.8z"/></svg>,
        BookOpen: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        Plus: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
        Search: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
        Sun: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
        Moon: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
    };

    // --- FACULTY DATA & HELPERS ---
    const FACULTY_DATA = {
        "הנדסת חשמל ומחשבים": [{ id: "electricalEngTracks.csv:Electrical Engineering", name: "הנדסת חשמל" }, { id: "electricalEngTracks.csv:Electrical Engineering and Mathematics", name: "הנדסת חשמל ומתמטיקה" }, { id: "electricalEngTracks.csv:Electrical and Computer Engineering", name: "הנדסת חשמל ומחשבים" }, { id: "electricalEngTracks.csv:Electrical Engineering and Physics", name: "הנדסת חשמל ופיזיקה" }, { id: "electricalEngTracks.csv:Combined Electrical Engineering and Physics", name: "הנדסת חשמל ופיזיקה (משולב)" }, { id: "electricalEngTracks.csv:Computer Engineering", name: "הנדסת מחשבים" }],
        "מדעי המחשב": [{ id: "csTracks.csv:Computer Science - General Four-Year Track", name: "מדעי המחשב (כללי 4 שנתי)" }, { id: "csTracks.csv:Computer Science and Computer Systems - Cyber Security Track", name: "סייבר ואבטחת מידע" }, { id: "csTracks.csv:Computer Science - General Three-Year Track", name: "מדעי המחשב (כללי 3 שנתי)" }, { id: "csTracks.csv:Computer Science - Learning and Data Analysis Track", name: "למידה וניתוח מידע" }, { id: "csTracks.csv:Computer Science - Bioinformatics Track", name: "ביואינפורמטיקה" }, { id: "csTracks.csv:Software Engineering Track", name: "הנדסת תוכנה" }, { id: "csTracks.csv:Computer Engineering Track", name: "הנדסת מחשבים (מדמ\"ח)" }, { id: "csTracks.csv:Computer Science and Mathematics - Combined Track", name: "מדעי המחשב ומתמטיקה" }, { id: "csTracks.csv:Computer Science and Physics - Combined Track", name: "מדעי המחשב ופיזיקה" }, { id: "csTracks.csv:Medicine and Computer Science - Double Degree Track", name: "רפואה ומדעי המחשב" }],
        "הנדסת מכונות": [{ id: "mechEngTracks.csv:Mechanical Engineering", name: "הנדסת מכונות" }, { id: "mechEngTracks.csv:BRAKIM", name: "ברקים (מצוינות)" }],
        "הנדסה אזרחית וסביבתית": [{ id: "civilEngTracks.csv:Civil Engineering - Water & Environment", name: "הנדסה אזרחית - מים וסביבה" }, { id: "civilEngTracks.csv:Civil Engineering - Transportation", name: "הנדסה אזרחית - תחבורה" }, { id: "civilEngTracks.csv:Civil Engineering", name: "הנדסה אזרחית (כללי/מבנים)" }, { id: "civilEngTracks.csv:Civil Engineering - Management and Construction", name: "ניהול ובנייה" }, { id: "civilEngTracks.csv:Environmental Engineering", name: "הנדסת סביבה" }, { id: "civilEngTracks.csv:Mapping and Geo-Information Engineering", name: "מיפוי וגיאו-אינפורמציה" }, { id: "civilEngTracks.csv:Mapping and Geo-Information 3Y Engineering", name: "מיפוי וגיאו-אינפורמציה (3 שנתי)" }],
        "הנדסת תעשייה וניהול": [{ id: "dataDecisionTracks.csv:Data and Information Engineering", name: "הנדסת נתונים ומידע" }, { id: "dataDecisionTracks.csv:Industrial Engineering and Management", name: "הנדסת תעשייה וניהול" }, { id: "dataDecisionTracks.csv:Information Systems Engineering", name: "מערכות מידע" }, { id: "dataDecisionTracks.csv:Medicine and Data Engineering", name: "רפואה והנדסת נתונים" }],
        "הנדסת אווירונאוטיקה וחלל": [{ id: "aerospaceTracks.csv:Aeronautics and Astronautics", name: "הנדסת אווירונאוטיקה" }, { id: "aerospaceTracks.csv:Aeronautics and Physics", name: "אווירונאוטיקה ופיזיקה" }],
        "הנדסה כימית": [{ id: "chemicalEngTracks.csv:Chemical Engineering", name: "הנדסה כימית" }, { id: "chemicalEngTracks.csv:Biochemical Engineering", name: "הנדסה ביוכימית" }],
        "הנדסת ביוטכנולוגיה ומזון": [{ id: "biotechFoodTracks.csv:Biotechnology and Food Engineering", name: "הנדסת ביוטכנולוגיה ומזון" }],
        "הנדסה ביו-רפואית": [{ id: "biomedicalTracks.csv:Biomedical Engineering", name: "הנדסה ביו-רפואית" }, { id: "biomedicalTracks.csv:Biomedical Engineering and Physics", name: "ביו-רפואה ופיזיקה" }, { id: "biomedicalTracks.csv:Medicine and Biomedical Engineering", name: "רפואה והנדסה ביו-רפואית" }],
        "הנדסת חומרים": [{ id: "materialsTracks.csv:Materials Engineering", name: "הנדסת חומרים" }, { id: "materialsTracks.csv:Materials Engineering and Physics", name: "הנדסת חומרים ופיזיקה" }, { id: "materialsTracks.csv:Materials Engineering and Chemistry", name: "הנדסת חומרים וכימיה" }, { id: "materialsTracks.csv:Materials Engineering and Biology", name: "הנדסת חומרים וביולוגיה" }],
        "ארכיטקטורה ובינוי ערים": [{ id: "architectureTracks.csv:Architecture and Town Planning", name: "ארכיטקטורה" }],
        "מתמטיקה": [{ id: "mathTracks.csv:Three-year program in Mathematics", name: "מתמטיקה (3 שנתי)" }, { id: "mathTracks.csv:Combined Mathematics-Physics", name: "מתמטיקה ופיזיקה (משולב)" }, { id: "mathTracks.csv:Mathematics with Computer Science", name: "מתמטיקה עם מדעי המחשב" }, { id: "mathTracks.csv:Applied Mathematics", name: "מתמטיקה שימושית" }, { id: "mathTracks.csv:Computer Science and Mathematics", name: "מדעי המחשב ומתמטיקה" }],
        "פיזיקה": [{ id: "physicsTracks.csv:Physics - Three-Year Track", name: "פיזיקה (3 שנתי)" }, { id: "physicsTracks.csv:Physics - Four-Year Track", name: "פיזיקה (4 שנתי)" }, { id: "physicsTracks.csv:Mathematics and Physics - Combined Three-Year Track", name: "מתמטיקה ופיזיקה (3 שנתי)" }, { id: "physicsTracks.csv:Physics - Electrical and Computer Engineering Track", name: "פיזיקה - מגמת הנדסת חשמל" }, { id: "physicsTracks.csv:Physics and Electrical Engineering - Combined Track", name: "פיזיקה והנדסת חשמל (משולב)" }, { id: "physicsTracks.csv:Computer Science and Physics - Combined Degree Track", name: "מדעי המחשב ופיזיקה (משולב)" }, { id: "physicsTracks.csv:Biomedical Engineering and Physics - Combined Degree Track", name: "הנדסה ביו-רפואית ופיזיקה" }, { id: "physicsTracks.csv:Aerospace Engineering and Physics - Combined Degree Track", name: "אווירונאוטיקה ופיזיקה" }],
        "כימיה": [{ id: "chemistryTracks.csv:Chemistry", name: "כימיה" }, { id: "chemistryTracks.csv:Haznek Chemistry - Medicinal", name: "כימיה - מזנק (רפואית)" }, { id: "chemistryTracks.csv:Haznek Chemistry - Technologies", name: "כימיה - מזנק (טכנולוגיות)" }, { id: "chemistryTracks.csv:Haznek Chemistry - Quantum", name: "כימיה - מזנק (קוונטים)" }, { id: "chemistryTracks.csv:Molecular Biochemistry", name: "ביוכימיה מולקולרית" }],
        "ביולוגיה": [{ id: "biologyTracks.csv:Biology", name: "ביולוגיה" }, { id: "biologyTracks.csv:Biology - Research and Human Development", name: "ביולוגיה - מחקר והתפתחות האדם" }, { id: "biologyTracks.csv:Biology - Microbiology Ecology and Environment", name: "ביולוגיה - מיקרוביולוגיה ואקולוגיה" }, { id: "biologyTracks.csv:Biology - Research in Biology and Molecular Biochemistry", name: "ביולוגיה - ביוכימיה מולקולרית" }, { id: "biologyTracks.csv:Double Major in Biology and Chemistry", name: "ביולוגיה וכימיה (דו-חוגי)" }],
        "רפואה": [{ id: "medicineTracks.csv:Medical Sciences", name: "מדעי הרפואה" }, { id: "medicineTracks.csv:Medicine and Biomedical Engineering", name: "רפואה והנדסה ביו-רפואית" }, { id: "medicineTracks.csv:Medicine and Computer Science - Double Degree Track", name: "רפואה ומדעי המחשב" }],
        "חינוך למדע וטכנולוגיה": [{ id: "educationTracks.csv:Mathematics Education", name: "הוראת המתמטיקה" }, { id: "educationTracks.csv:Physics Education", name: "הוראת הפיזיקה" }, { id: "educationTracks.csv:Chemistry Education", name: "הוראת הכימיה" }, { id: "educationTracks.csv:Biology-Environmental Sciences Education", name: "הוראת הביולוגיה ומדעי הסביבה" }, { id: "educationTracks.csv:Computer Science Education", name: "הוראת מדעי המחשב" }, { id: "educationTracks.csv:Technology-Mechanical Education", name: "הוראת טכנולוגיה-מכונות" }, { id: "educationTracks.csv:Electronics-Electricity Education", name: "הוראת חשמל ואלקטרוניקה" }]
    };

    const normalizeId = (id) => String(id).trim();

    const getAllAncestors = (courseId, allCourses) => {
        const ancestors = new Set();
        try {
            const find = (cId, depth = 0) => {
                if (depth > 20) return; 
                const course = allCourses.find(c => c.id === cId);
                if (!course || !course.prereqs) return;
                course.prereqs.forEach(pId => {
                    if (!ancestors.has(pId)) { ancestors.add(pId); find(pId, depth + 1); }
                });
            };
            find(courseId);
        } catch (e) { console.warn("Ancestor finding error", e); }
        return ancestors;
    };

    const getBlockingCount = (courseId, allCourses) => {
        return allCourses.filter(c => c.prereqs && c.prereqs.includes(courseId)).length;
    };

    const checkPrerequisiteLogic = (prereqString, targetSemester, currentCourses) => {
        if (!prereqString || typeof prereqString !== 'string' || !prereqString.trim()) return true;
        try {
            const courseIds = prereqString.match(/\d{6,8}/g);
            if (!courseIds) return true;

            const completionMap = {};
            courseIds.forEach(id => {
                const normalizedId = normalizeId(id);
                const courseInBoard = currentCourses.find(c => c.id === normalizedId);
                const isCompleted = (courseInBoard && courseInBoard.completed) || (courseInBoard && courseInBoard.semester < targetSemester);
                completionMap[id] = isCompleted;
            });

            let cleanStr = prereqString
                .replace(/א[וֹ]/g, "||")
                .replace(/\sOR\s/gi, "||")
                .replace(/וגם/g, "&&")
                .replace(/\sAND\s/gi, "&&")
                .replace(/[\[\{]/g, "(")
                .replace(/[\]\}]/g, ")");

            const ids = Object.keys(completionMap).sort((a,b) => b.length - a.length);
            ids.forEach(id => {
                 cleanStr = cleanStr.split(id).join(completionMap[id].toString());
            });

            const safeEvalStr = cleanStr.replace(/[^truefalse\(\)\&\|!\s]/gi, "");
            const result = new Function(`return (${safeEvalStr});`)();
            return !!result;

        } catch (e) {
            const values = Object.values(completionMap || {});
            const completedCount = values.filter(v => v === true).length;
            const requiredCount = values.length;
            if (requiredCount > 1 && completedCount > 0) return true; 
            return false;
        }
    };

    const checkPrerequisiteError = (course, allCourses) => {
        try {
            if (course.prereqString) {
                if (checkPrerequisiteLogic(course.prereqString, course.semester, allCourses)) return null;
                return "דרישות הקדם לא הושלמו";
            }
            if (!course.prereqs || !Array.isArray(course.prereqs)) return null;
            const missing = course.prereqs.filter(pid => {
                const pre = allCourses.find(c => c.id === pid);
                return !pre || (!pre.completed && pre.semester >= course.semester);
            });
            return missing.length > 0 ? "חסרים קדמים" : null;
        } catch (e) { return null; }
    };

    const getFacultyColor = (id, highlightState) => {
        const cleanId = String(id).replace(/^0+/, ''); 
        const prefix = cleanId.substring(0, 2);
        
        let colorClass = "";
        // Colors: [Light Mode] / [Dark Mode]
        switch(prefix) {
            case '23': colorClass = "bg-emerald-50 border-emerald-200 border-l-emerald-600 text-emerald-900 dark:bg-emerald-950/40 dark:border-emerald-800 dark:border-l-emerald-500 dark:text-emerald-200"; break;
            case '10': colorClass = "bg-blue-50 border-blue-200 border-l-blue-600 text-blue-900 dark:bg-blue-950/40 dark:border-blue-800 dark:border-l-blue-500 dark:text-blue-200"; break;
            case '11': colorClass = "bg-violet-50 border-violet-200 border-l-violet-600 text-violet-900 dark:bg-violet-950/40 dark:border-violet-800 dark:border-l-violet-500 dark:text-violet-200"; break;
            case '04': colorClass = "bg-amber-50 border-amber-200 border-l-amber-600 text-amber-900 dark:bg-amber-950/40 dark:border-amber-800 dark:border-l-amber-500 dark:text-amber-200"; break;
            case '09': colorClass = "bg-fuchsia-50 border-fuchsia-200 border-l-fuchsia-600 text-fuchsia-900 dark:bg-fuchsia-950/40 dark:border-fuchsia-800 dark:border-l-fuchsia-500 dark:text-fuchsia-200"; break;
            case '01': colorClass = "bg-orange-50 border-orange-200 border-l-orange-600 text-orange-900 dark:bg-orange-950/40 dark:border-orange-800 dark:border-l-orange-500 dark:text-orange-200"; break;
            case '08': colorClass = "bg-sky-50 border-sky-200 border-l-sky-600 text-sky-900 dark:bg-sky-950/40 dark:border-sky-800 dark:border-l-sky-500 dark:text-sky-200"; break;
            case '12': 
            case '13': colorClass = "bg-rose-50 border-rose-200 border-l-rose-600 text-rose-900 dark:bg-rose-950/40 dark:border-rose-800 dark:border-l-rose-500 dark:text-rose-200"; break;
            default: colorClass = "bg-white border-slate-200 border-l-slate-400 text-slate-700 dark:bg-slate-800 dark:border-slate-600 dark:border-l-slate-400 dark:text-slate-300";
        }

        const baseStyle = "border-l-[4px] shadow-sm hover:shadow-md transition-all";
        
        if (highlightState === 'dimmed') return `${baseStyle} bg-slate-50 border-slate-100 opacity-20 grayscale border-l-slate-200 dark:bg-slate-900/50 dark:border-slate-800`;
        if (highlightState === 'focused') return `${baseStyle} ${colorClass} scale-[1.02] shadow-lg ring-2 ring-indigo-400 dark:ring-indigo-500 z-30`;
        if (highlightState === 'ancestor') return `${baseStyle} bg-blue-50 border-blue-400 ring-1 ring-blue-300 z-20 dark:bg-blue-900/30 dark:border-blue-500`;
        if (highlightState === 'descendant') return `${baseStyle} bg-amber-50 border-amber-400 ring-1 ring-amber-300 z-20 dark:bg-amber-900/30 dark:border-amber-500`;
        
        return `${baseStyle} ${colorClass}`;
    };

    // --- SUB-COMPONENTS ---

    const TrackSelectionModal = memo(({ isOpen, onClose, onSelectTrack }) => {
        if (!isOpen) return null;
        const [expandedFaculty, setExpandedFaculty] = React.useState(null);
        const toggleFaculty = (faculty) => setExpandedFaculty(expandedFaculty === faculty ? null : faculty);

        return (
            <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[80] backdrop-blur-sm p-4 animate-in fade-in">
                <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl max-w-2xl w-full h-[80vh] flex flex-col border border-slate-200 dark:border-slate-700 overflow-hidden">
                    <div className="p-4 bg-slate-50 dark:bg-slate-850 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center shrink-0">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100 flex items-center gap-2">
                             <Icons.BookOpen size={24} className="text-indigo-600 dark:text-indigo-400"/>
                             בחר מסלול לימודים
                        </h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 font-bold p-2 bg-slate-200/50 dark:bg-slate-700/50 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors w-8 h-8 flex items-center justify-center">✕</button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-2 bg-slate-100 dark:bg-slate-900">
                        <div className="space-y-2">
                        {Object.entries(FACULTY_DATA).map(([facultyName, tracks]) => {
                            const isOpen = expandedFaculty === facultyName;
                            return (
                                <div key={facultyName} className="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                                    <button onClick={() => toggleFaculty(facultyName)} className={`w-full px-5 py-4 flex items-center justify-between transition-colors ${isOpen ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                        <span className="font-bold text-base">{facultyName}</span>
                                        {isOpen ? <Icons.ChevronUp size={20} /> : <Icons.ChevronDown size={20} className="text-slate-400" />}
                                    </button>
                                    {isOpen && (
                                        <div className="bg-slate-50 dark:bg-slate-850 px-4 py-3 border-t border-indigo-100 dark:border-slate-700 shadow-inner">
                                            {tracks.length > 0 ? (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    {tracks.map((track) => (
                                                        <button key={track.id} onClick={() => onSelectTrack(track.id)} className="text-right px-4 py-3 rounded-lg text-sm text-slate-600 dark:text-slate-300 hover:text-indigo-700 dark:hover:text-indigo-300 hover:bg-white dark:hover:bg-slate-700 hover:shadow-md transition-all border border-slate-200 dark:border-slate-700 hover:border-indigo-200 dark:hover:border-indigo-500/50 flex items-center gap-3 bg-white dark:bg-slate-800">
                                                            <div className="w-2 h-2 rounded-full bg-indigo-400 shrink-0"></div><span className="font-medium">{track.name}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            ) : <div className="text-center text-slate-400 text-sm py-2">(אין מסלולים זמינים)</div>}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        </div>
                    </div>
                </div>
            </div>
        );
    });

    const CourseCard = memo(({ course, highlightState, error, blockCount, onToggle, onEdit, onDelete, onDragStart, onHover, onLeave, setRef }) => {
        return (
            <div 
                ref={setRef}
                draggable 
                onDragStart={(e) => onDragStart(e, course)} 
                onMouseEnter={() => onHover(course)} 
                onMouseLeave={onLeave} 
                className={`relative p-3 rounded-xl border select-none group course-card
                    ${getFacultyColor(course.id, highlightState)} 
                    ${error && !course.completed ? '!border-red-400 !bg-red-50 dark:!bg-red-900/20 dark:!border-red-500' : ''}
                    ${course.completed ? '!bg-green-50 !border-green-400 dark:!bg-green-900/20 dark:!border-green-600' : ''} 
                    overflow-hidden
                `}
            >
                <div className="flex justify-between items-start gap-2 mb-2">
                    <div className="flex-1 min-w-0">
                        <h4 className={`font-bold text-sm leading-tight truncate ${course.completed ? 'line-through opacity-60' : ''}`} title={course.name}>{course.name}</h4>
                        <div className="flex items-center gap-2 mt-1">
                            <span className="text-[10px] bg-slate-100 dark:bg-slate-950/50 px-1.5 rounded text-slate-500 dark:text-slate-400 font-mono">{course.id}</span>
                            <span className="text-[10px] text-blue-600 dark:text-blue-400 font-bold">{course.credits} נק'</span>
                            {blockCount > 2 && <div className="flex items-center gap-0.5 text-[10px] text-orange-600 dark:text-orange-400 font-bold bg-orange-100 dark:bg-orange-900/40 px-1.5 rounded-full" title={`חוסם ${blockCount} קורסים בהמשך (נתיב קריטי)`}><Icons.Fire size={10}/> {blockCount}</div>}
                        </div>
                    </div>
                    <div className="flex flex-col gap-1 z-10">
                        <button onClick={(e) => { e.stopPropagation(); onToggle(course.id); }} className={`w-5 h-5 rounded-full border flex items-center justify-center transition-colors ${course.completed ? 'bg-green-500 border-green-600 dark:bg-green-600 dark:border-green-500' : 'border-slate-300 dark:border-slate-500 hover:border-indigo-400 bg-white dark:bg-slate-800'}`}>
                            {course.completed && <Icons.Check size={10} />}
                        </button>
                    </div>
                </div>

                {/* SLIDE-UP ACTION BAR */}
                <div className="action-bar absolute bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-800/95 border-t border-slate-200 dark:border-slate-600 px-3 py-1.5 flex items-center justify-between backdrop-blur-sm z-20">
                     <span className="text-[10px] text-slate-400 font-bold">פעולות:</span>
                     <div className="flex gap-3">
                        <button onClick={(e) => { e.stopPropagation(); onEdit(course); }} className="text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 flex items-center gap-1 text-xs font-bold hover:bg-indigo-50 dark:hover:bg-indigo-900/50 px-2 py-0.5 rounded transition-colors"><Icons.Pencil size={12}/> ערוך</button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(course.id); }} className="text-slate-500 dark:text-slate-400 hover:text-red-600 dark:hover:text-red-400 flex items-center gap-1 text-xs font-bold hover:bg-red-50 dark:hover:bg-red-900/50 px-2 py-0.5 rounded transition-colors"><Icons.Trash2 size={12}/> מחק</button>
                     </div>
                </div>

                {error && !course.completed && (
                    <div className="mt-1 text-[10px] text-red-600 dark:text-red-300 bg-red-100/50 dark:bg-red-900/30 px-2 py-1 rounded border border-red-200 dark:border-red-800 flex items-center gap-1">
                        <Icons.AlertCircle size={10} /> 
                        <span className="truncate">{error}</span>
                    </div>
                )}
            </div>
        );
    });

    // --- MAIN COMPONENT ---

    function DegreePlanner() {
        // Theme State
        const [isDarkMode, setIsDarkMode] = useState(() => {
            if (typeof window !== 'undefined') {
                const saved = localStorage.getItem('bananabread_theme');
                return saved ? saved === 'dark' : window.matchMedia('(prefers-color-scheme: dark)').matches;
            }
            return false;
        });

        const [catalog, setCatalog] = useState([]); 
        const [loadingStatus, setLoadingStatus] = useState("loading");
        const [statusMessage, setStatusMessage] = useState("טוען קטלוג...");
        const [courses, setCourses] = useState([]);
        const [semesterCount, setSemesterCount] = useState(8);
        const [draggedCourse, setDraggedCourse] = useState(null);
        const [hoveredCourse, setHoveredCourse] = useState(null);
        
        const [isEditing, setIsEditing] = useState(false);
        const [editingId, setEditingId] = useState(null);
        const [showPrereqSelector, setShowPrereqSelector] = useState(false);
        const [showTrackModal, setShowTrackModal] = useState(false);
        
        // Form states
        const [newCourseName, setNewCourseName] = useState('');
        const [newCourseCredits, setNewCourseCredits] = useState(3);
        const [newCourseSem, setNewCourseSem] = useState(1);
        const [newCoursePrereqs, setNewCoursePrereqs] = useState([]);
        const [newCourseId, setNewCourseId] = useState(null);
        const [newCourseFaculty, setNewCourseFaculty] = useState('');
        const [suggestions, setSuggestions] = useState([]);
        const [showSuggestions, setShowSuggestions] = useState(false);
        const [searchQuery, setSearchQuery] = useState("");
        
        const [pendingCourse, setPendingCourse] = useState(null);
        const [missingPrereqOptions, setMissingPrereqOptions] = useState([]);
        const [selectedPrereqsToAdd, setSelectedPrereqsToAdd] = useState([]);
        const [showAllConnections, setShowAllConnections] = useState(false);
        const [connections, setConnections] = useState([]);

        const wrapperRef = useRef(null);
        const courseRefs = useRef({});
        const containerRef = useRef(null);
        const fileInputRef = useRef(null);

        // Dark Mode Effect
        useEffect(() => {
            const root = document.documentElement;
            if (isDarkMode) {
                root.classList.add('dark');
                localStorage.setItem('bananabread_theme', 'dark');
            } else {
                root.classList.remove('dark');
                localStorage.setItem('bananabread_theme', 'light');
            }
        }, [isDarkMode]);

        // Load / Save Logic
        useEffect(() => {
            const savedCourses = localStorage.getItem("technion_planner_courses_v5");
            const savedSemesters = localStorage.getItem("technion_planner_semesters_v5");
            if (savedCourses) { try { setCourses(JSON.parse(savedCourses)); } catch(e) {} }
            if (savedSemesters) setSemesterCount(parseInt(savedSemesters));
        }, []);

        useEffect(() => {
            if (courses.length > 0 || semesterCount !== 8) {
                localStorage.setItem("technion_planner_courses_v5", JSON.stringify(courses));
                localStorage.setItem("technion_planner_semesters_v5", semesterCount.toString());
            }
        }, [courses, semesterCount]);

        // Load Catalog
        useEffect(() => {
            const loadData = async () => {
                const fetchCsv = (file) => new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: (err) => reject(err)
                    });
                });
                try {
                    const coursesRaw = await fetchCsv('courses.csv');
                    if (!coursesRaw || coursesRaw.length === 0) throw new Error("קובץ ריק");
                    const processedCatalog = coursesRaw.map(row => {
                        if (!row.id) return null;
                        return {
                            id: normalizeId(row.id), name: row.name || "ללא שם", credits: parseFloat(row.points || row.credits || 0),
                            faculty: row.faculty || "", recSem: 1, 
                            prereqs: (row.prerequisites || "").match(/\d{6,8}/g)?.map(n => normalizeId(n)) || [], 
                            prereqString: row.prerequisites || "" 
                        };
                    }).filter(Boolean);
                    setCatalog(processedCatalog);
                    setLoadingStatus("success");
                    setStatusMessage(`קטלוג: ${processedCatalog.length} קורסים`);
                } catch (err) {
                    setLoadingStatus("error");
                    setStatusMessage(`שגיאה בטעינת קטלוג. וודא שקובץ courses.csv קיים.`);
                }
            };
            loadData();
        }, []);

        // Connection Lines Logic
        const updateConnections = useCallback(() => {
            if (!containerRef.current) { setConnections([]); return; }
            if (!showAllConnections && !hoveredCourse) { setConnections([]); return; }
            
            requestAnimationFrame(() => {
                try {
                    const newConnections = [];
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const scrollLeft = containerRef.current.scrollLeft;
                    const scrollTop = containerRef.current.scrollTop;

                    const getCoords = (id) => {
                        const el = courseRefs.current[id];
                        if (!el) return null;
                        const rect = el.getBoundingClientRect();
                        return {
                            left: rect.left - containerRect.left + scrollLeft, 
                            right: rect.right - containerRect.left + scrollLeft,
                            centerY: (rect.top + rect.bottom) / 2 - containerRect.top + scrollTop
                        };
                    };

                    const createPath = (src, tgt) => {
                        const startX = tgt.left; const startY = tgt.centerY;
                        const endX = src.right; const endY = src.centerY;
                        const dist = Math.abs(startX - endX);
                        const controlOffset = Math.min(dist * 0.5, 80); 
                        return `M ${startX} ${startY} C ${startX - controlOffset} ${startY}, ${endX + controlOffset} ${endY}, ${endX} ${endY}`;
                    };

                    const baseLineColor = isDarkMode ? "#475569" : "#cbd5e1"; // slate-600 vs slate-300

                    if (showAllConnections) {
                        courses.forEach(c => {
                            if (!c.prereqs || c.prereqs.length === 0) return;
                            const sourceCoords = getCoords(c.id);
                            if (!sourceCoords) return;
                            c.prereqs.forEach(pid => {
                                const prereqCourse = courses.find(pc => pc.id === pid);
                                if (prereqCourse) {
                                    const targetCoords = getCoords(pid);
                                    if (targetCoords) newConnections.push({ id: `${c.id}-${pid}`, path: createPath(sourceCoords, targetCoords), color: baseLineColor, opacity: 0.3, width: 2 });
                                }
                            });
                        });
                    } 
                    
                    if (hoveredCourse) {
                        const ancestors = getAllAncestors(hoveredCourse.id, courses);
                        const chainSet = new Set([...ancestors, hoveredCourse.id]);
                        
                        courses.forEach(c => {
                            if (chainSet.has(c.id) && c.prereqs) {
                                c.prereqs.forEach(pid => {
                                    if (chainSet.has(pid)) {
                                        const src = getCoords(c.id); const tgt = getCoords(pid);
                                        if (src && tgt) newConnections.push({ id: `chain-${c.id}-${pid}`, path: createPath(src, tgt), color: "#3b82f6", opacity: 0.8, width: 3 });
                                    }
                                });
                            }
                        });
                        
                        courses.filter(c => c.prereqs && c.prereqs.includes(hoveredCourse.id)).forEach(post => {
                            const src = getCoords(post.id); const tgt = getCoords(hoveredCourse.id);
                            if (src && tgt) newConnections.push({ id: `post-${post.id}`, path: createPath(src, tgt), color: "#f59e0b", opacity: 0.8, width: 3 });
                        });
                    }
                    setConnections(newConnections);
                } catch(e) { setConnections([]); }
            });
        }, [hoveredCourse, courses, showAllConnections, isDarkMode]);

        useEffect(() => { updateConnections(); }, [updateConnections]);

        // Handlers
        const resetAllData = () => {
            if(confirm("בטוח שברצונך למחוק הכל ולהתחיל מחדש?")) {
                setCourses([]); setSemesterCount(8);
                localStorage.removeItem("technion_planner_courses_v5");
                localStorage.removeItem("technion_planner_semesters_v5");
            }
        };

        const handleExport = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({courses, semesterCount, version: "23.2"}));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "bananabread_plan.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        const handleImportClick = () => fileInputRef.current.click();
        const handleImportFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.courses) setCourses(json.courses);
                    if(json.semesterCount) setSemesterCount(json.semesterCount);
                    alert("התוכנית נטענה בהצלחה!");
                } catch(err) { alert("שגיאה בטעינת הקובץ"); }
            };
            reader.readAsText(file);
            event.target.value = null; 
        };

        const handleTrackSelect = async (selectionId) => {
            if (!selectionId) return;
            const [fileName, trackName] = selectionId.split(':');
            if (courses.length > 0 && !window.confirm("טעינת מסלול תמחק את הקורסים הקיימים. להמשיך?")) return; 
            
            setLoadingStatus("loading"); setStatusMessage(`טוען מסלול ${trackName}...`); setShowTrackModal(false);
            try {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error(`הקובץ ${fileName} לא נמצא`);
                Papa.parse(await response.text(), {
                    header: true, skipEmptyLines: true,
                    complete: (results) => {
                        const trackRows = results.data.filter(row => row.track_name === trackName);
                        if (trackRows.length === 0) throw new Error(`המסלול לא נמצא בקובץ`);
                        const newBoard = []; let maxSem = semesterCount;
                        trackRows.forEach(row => {
                            const cId = normalizeId(row.course_id || row.id); 
                            const semester = parseInt(row.semester || row.recommended_semester);
                            if (semester > maxSem) maxSem = semester;
                            const fullDetails = catalog.find(c => c.id === cId);
                            if (fullDetails) newBoard.push({ ...fullDetails, semester: semester, completed: false });
                            else newBoard.push({ id: cId, name: cId, credits: 0, semester: semester, completed: false });
                        });
                        if (maxSem > semesterCount) setSemesterCount(maxSem);
                        setCourses(newBoard); setLoadingStatus("success"); setStatusMessage("מסלול נטען");
                    },
                    error: (err) => { throw new Error("שגיאת CSV"); }
                });
            } catch (err) { setLoadingStatus("error"); setStatusMessage(`שגיאה: ${err.message}`); }
        };

        const toggleCourseCompletion = useCallback((courseId) => {
            setCourses(prev => prev.map(c => c.id === courseId ? { ...c, completed: !c.completed } : c));
        }, []);

        const handleSaveCourse = () => {
            if (!newCourseName) return;
            const targetSem = parseInt(newCourseSem);
            const catalogCourse = catalog.find(c => c.id === newCourseId);
            const prereqStr = catalogCourse ? catalogCourse.prereqString : "";
            
            const courseData = {
                id: newCourseId || Math.random().toString(36).substr(2, 9),
                name: newCourseName, semester: targetSem, credits: parseFloat(newCourseCredits) || 0,
                prereqs: newCoursePrereqs || [], faculty: newCourseFaculty || '', prereqString: prereqStr, completed: false
            };

            if (editingId) {
                setCourses(prev => [...prev.filter(c => c.id !== editingId), courseData]); setIsEditing(false); return;
            }

            let missingIds = [];
            if (prereqStr) missingIds = (prereqStr.match(/\d{6,8}/g) || []).filter(pid => !courses.find(c => c.id === pid));
            
            if (missingIds.length > 0) {
                const options = missingIds.map(mid => {
                    const catInfo = catalog.find(c => c.id === mid);
                    return { id: mid, name: catInfo ? catInfo.name : mid };
                }).filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i);

                setPendingCourse(courseData); setMissingPrereqOptions(options); setSelectedPrereqsToAdd([]); 
                setIsEditing(false); setShowPrereqSelector(true); return;
            }

            setCourses([...courses, courseData]); setIsEditing(false);
        };

        const confirmPrereqSelection = () => {
            if (!pendingCourse) return;
            let targetCourse = { ...pendingCourse };
            let prereqSemester = Math.max(1, targetCourse.semester - 1);
            if (selectedPrereqsToAdd.length > 0 && targetCourse.semester <= 1) { targetCourse.semester = 2; prereqSemester = 1; }
            const extras = selectedPrereqsToAdd.map(pid => {
                const catInfo = catalog.find(c => c.id === pid);
                return {
                    id: pid, name: catInfo ? catInfo.name : pid, credits: catInfo ? catInfo.credits : 0,
                    faculty: catInfo ? catInfo.faculty : '', semester: prereqSemester, 
                    prereqs: catInfo ? catInfo.prereqs : [], prereqString: catInfo ? catInfo.prereqString : "", completed: false
                };
            });
            setCourses([...courses, ...extras, targetCourse]); setShowPrereqSelector(false); setPendingCourse(null);
        };

        const handleDeleteCourse = useCallback((id) => {
            if(confirm("למחוק קורס זה?")) setCourses(prev => prev.filter(c => c.id !== id));
        }, []);

        const handleDragStart = useCallback((e, course) => { setDraggedCourse(course); }, []);
        const handleDragOver = (e) => e.preventDefault();
        const handleDrop = (e, targetSemester) => { 
            e.preventDefault(); 
            if (!draggedCourse) return; 
            setCourses(prev => prev.map(c => c.id === draggedCourse.id ? { ...c, semester: targetSemester } : c)); 
            setDraggedCourse(null); 
        };

        // UI State Logic
        const getHighlightState = (courseId) => {
            if (searchQuery && searchQuery.length > 1) {
                const c = courses.find(x => x.id === courseId);
                const match = c && (c.name.includes(searchQuery) || c.id.includes(searchQuery));
                if (match) return 'focused';
                return 'dimmed';
            }

            if (!hoveredCourse) return 'normal';
            if (hoveredCourse.id === courseId) return 'focused';
            
            const ancestors = getAllAncestors(hoveredCourse.id, courses);
            if (ancestors.has(courseId)) return 'ancestor';
            
            const blocking = courses.find(c => c.id === courseId)?.prereqs?.includes(hoveredCourse.id);
            if (blocking) return 'descendant';
            
            if (!showAllConnections) return 'dimmed';
            
            return 'normal';
        };

        const totalCredits = courses.reduce((acc, c) => acc + (c.credits || 0), 0);
        const completedCredits = courses.reduce((acc, c) => acc + (c.completed ? (c.credits || 0) : 0), 0);
        const progress = totalCredits > 0 ? (completedCredits / totalCredits) * 100 : 0;

        const openAddModal = (sem) => { setEditingId(null); setNewCourseName(''); setNewCourseSem(sem); setNewCourseId(null); setSuggestions([]); setIsEditing(true); };
        const openEditModal = useCallback((c) => { setEditingId(c.id); setNewCourseName(c.name); setNewCourseCredits(c.credits); setNewCourseSem(c.semester); setNewCoursePrereqs(c.prereqs||[]); setNewCourseId(c.id); setNewCourseFaculty(c.faculty); setIsEditing(true); }, []);
        const handleNameChange = (e) => {
            const val = e.target.value; setNewCourseName(val);
            if (val.length > 1) { 
                const searchVal = normalizeId(val); 
                setSuggestions(catalog.filter(c => c.name.includes(val) || c.id.includes(searchVal)).slice(0, 10)); setShowSuggestions(true); 
            } else setShowSuggestions(false);
        };

        return (
            <div className="flex flex-col h-screen overflow-hidden bg-slate-100 dark:bg-slate-900 font-sans text-slate-900 dark:text-slate-100 transition-colors duration-200">
                {/* HEADER */}
                <div className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm z-40 px-6 py-3 flex justify-between items-center shrink-0 transition-colors">
                    <div className="flex items-center gap-4">
                        <div className="flex flex-col">
                            <h1 className="text-2xl font-black bg-gradient-to-r from-yellow-600 to-amber-700 dark:from-yellow-400 dark:to-amber-500 bg-clip-text text-transparent flex items-center gap-2">
                                BananaBread <span className="text-xs bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-0.5 rounded-full border dark:border-slate-600">v23.2</span>
                            </h1>
                        </div>
                        <div className="h-8 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setShowTrackModal(true)} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 dark:bg-indigo-900/40 hover:bg-indigo-100 dark:hover:bg-indigo-900/60 text-indigo-700 dark:text-indigo-300 rounded-lg text-sm font-bold transition-colors">
                                <Icons.BookOpen size={16}/> מסלול
                            </button>
                            <button onClick={() => setShowAllConnections(!showAllConnections)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-bold transition-colors border ${showAllConnections ? 'bg-slate-800 text-white dark:bg-slate-200 dark:text-slate-900 border-slate-800' : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>
                                {showAllConnections ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>} תלות
                            </button>
                            
                            {/* Search Bar */}
                            <div className="relative group ml-4">
                                <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none text-slate-400">
                                    <Icons.Search size={14}/>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="חיפוש מהיר..." 
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="pr-9 pl-3 py-1.5 bg-slate-100 dark:bg-slate-700 border border-transparent focus:bg-white dark:focus:bg-slate-600 focus:border-indigo-300 rounded-lg text-sm w-48 transition-all focus:w-64 outline-none text-slate-900 dark:text-white"
                                />
                                {searchQuery && <button onClick={() => setSearchQuery('')} className="absolute inset-y-0 left-0 flex items-center pl-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">✕</button>}
                            </div>
                        </div>
                        {loadingStatus !== 'success' && <span className="text-xs flex items-center gap-1 bg-amber-50 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 px-2 py-1 rounded"><Icons.Loader size={12}/> {statusMessage}</span>}
                    </div>

                    <div className="flex items-center gap-3">
                        <button 
                            onClick={() => setIsDarkMode(!isDarkMode)} 
                            className="text-slate-500 hover:text-amber-500 dark:text-slate-400 dark:hover:text-amber-300 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                            title={isDarkMode ? "מצב יום" : "מצב לילה"}
                        >
                            {isDarkMode ? <Icons.Sun size={18}/> : <Icons.Moon size={18}/>}
                        </button>
                        <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                        <input type="file" ref={fileInputRef} onChange={handleImportFile} className="hidden" accept=".json" />
                        <button onClick={handleImportClick} className="text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700" title="טען תוכנית"><Icons.Upload size={18}/></button>
                        <button onClick={handleExport} className="text-slate-500 hover:text-indigo-600 dark:text-slate-400 dark:hover:text-indigo-400 p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-700" title="שמור תוכנית"><Icons.Download size={18}/></button>
                        <div className="w-px h-6 bg-slate-200 dark:bg-slate-700"></div>
                        <button onClick={resetAllData} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/30 rounded" title="איפוס"><Icons.Refresh size={16}/></button>
                    </div>
                </div>

                {/* MODALS */}
                <TrackSelectionModal isOpen={showTrackModal} onClose={() => setShowTrackModal(false)} onSelectTrack={handleTrackSelect} />
                
                {showPrereqSelector && (
                    <div className="fixed inset-0 bg-slate-900/40 flex items-center justify-center z-[70] backdrop-blur-sm">
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-xl max-w-lg w-full animate-in zoom-in-95 border border-slate-200 dark:border-slate-700">
                            <div className="flex items-start gap-3 mb-4">
                                <div className="bg-amber-100 dark:bg-amber-900/40 p-2 rounded-full text-amber-600 dark:text-amber-400"><Icons.GitBranch size={24}/></div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100">השלמת קדמים</h3>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">הקורס <strong>{pendingCourse?.name}</strong> דורש קורסים שחסרים בלוח.</p>
                                </div>
                            </div>
                            <div className="max-h-60 overflow-y-auto custom-scrollbar border dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 p-2 mb-4">
                                {missingPrereqOptions.map(opt => (
                                    <label key={opt.id} className="flex items-center gap-3 p-3 bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 mb-2 hover:border-indigo-400 dark:hover:border-indigo-500 cursor-pointer">
                                        <input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={selectedPrereqsToAdd.includes(opt.id)} onChange={() => setSelectedPrereqsToAdd(prev => prev.includes(opt.id) ? prev.filter(x => x !== opt.id) : [...prev, opt.id])} />
                                        <div><div className="font-bold text-slate-700 dark:text-slate-200 text-sm">{opt.name}</div><div className="text-xs text-slate-400">{opt.id}</div></div>
                                    </label>
                                ))}
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setShowPrereqSelector(false)} className="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg text-sm">ביטול</button>
                                <button onClick={confirmPrereqSelection} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold">הוסף מסומנים</button>
                            </div>
                        </div>
                    </div>
                )}

                {isEditing && (
                    <div className="fixed inset-0 bg-slate-900/30 flex items-start justify-center pt-20 z-[60] backdrop-blur-sm">
                        <div className="w-full max-w-2xl bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl animate-in slide-in-from-bottom-4 border border-slate-200 dark:border-slate-700">
                            <h3 className="font-bold text-xl text-slate-800 dark:text-slate-100 mb-4">{editingId ? 'עריכת קורס' : 'הוספת קורס'}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" ref={wrapperRef}>
                                <div className="md:col-span-2 relative">
                                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">שם הקורס</label>
                                    <input className="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" value={newCourseName} onChange={handleNameChange} placeholder="הקלד שם או מספר..." autoFocus />
                                    {showSuggestions && (
                                        <div className="absolute w-full bg-white dark:bg-slate-700 border dark:border-slate-600 shadow-xl rounded-lg mt-1 max-h-48 overflow-y-auto z-50">
                                            {suggestions.map(s => (
                                                <button key={s.id} onClick={() => { setNewCourseName(s.name); setNewCourseCredits(s.credits); setNewCourseId(s.id); setNewCourseFaculty(s.faculty); setNewCoursePrereqs(courses.filter(c => s.prereqs.includes(c.id)).map(c=>c.id)); setShowSuggestions(false); }} className="w-full text-right px-4 py-2 hover:bg-indigo-50 dark:hover:bg-slate-600 border-b dark:border-slate-600 flex justify-between">
                                                    <span>{s.name}</span><span className="text-xs bg-slate-100 dark:bg-slate-800 px-2 rounded">{s.id}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">נקודות</label><input type="number" step="0.5" className="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded-lg" value={newCourseCredits} onChange={e=>setNewCourseCredits(e.target.value)}/></div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">סמסטר</label>
                                    <select className="w-full border dark:border-slate-600 dark:bg-slate-700 dark:text-white p-2 rounded-lg" value={newCourseSem} onChange={e=>setNewCourseSem(e.target.value)}>
                                        {Array.from({length: semesterCount},(_,i)=>i+1).map(s=><option key={s} value={s}>סמסטר {s}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="flex justify-end gap-3 pt-4 border-t dark:border-slate-700">
                                <button onClick={() => setIsEditing(false)} className="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg">ביטול</button>
                                <button onClick={handleSaveCourse} className="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold flex items-center gap-2"><Icons.Save size={16}/> שמור</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* MAIN BOARD */}
                <div className="flex-1 overflow-x-auto overflow-y-hidden relative custom-scrollbar bg-slate-100 dark:bg-slate-900 transition-colors" ref={containerRef}>
                    <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0" style={{minWidth: 'max-content', height: '100%'}}>
                        {connections.map((conn, i) => (
                            <path key={conn.id + i} d={conn.path} stroke={conn.color} strokeOpacity={conn.opacity} strokeWidth={conn.width || 2} className="connection-line" />
                        ))}
                    </svg>
                    
                    <div className="flex gap-4 p-4 min-w-max h-full items-start">
                      {Array.from({length: semesterCount}, (_, i) => i + 1).map((semNum) => {
                        const semCourses = courses.filter(c => c.semester === semNum);
                        const semCredits = semCourses.reduce((sum, c) => sum + (c.credits || 0), 0);
                        
                        return (
                          <div key={semNum} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, semNum)} className="w-80 flex flex-col h-[calc(100vh-140px)] rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm transition-colors hover:border-indigo-300 dark:hover:border-indigo-500 z-10">
                            {/* Semester Header */}
                            <div className={`p-3 border-b border-slate-100 dark:border-slate-700 rounded-t-2xl flex justify-between items-center ${semCredits > 27 ? 'bg-red-50 dark:bg-red-900/20' : 'bg-slate-50 dark:bg-slate-850'}`}>
                              <div>
                                  <h2 className="font-bold text-slate-700 dark:text-slate-200">סמסטר {semNum}</h2>
                                  <div className={`text-xs font-bold ${semCredits > 27 ? 'text-red-600 dark:text-red-400' : 'text-slate-400'}`}>{semCredits} נק'</div>
                              </div>
                              <button onClick={() => openAddModal(semNum)} className="text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded-full transition-colors"><Icons.PlusCircle size={20}/></button>
                            </div>

                            {/* Course List */}
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar bg-slate-50/50 dark:bg-slate-900/50">
                              {semCourses.length === 0 && (
                                  <div className="h-full flex flex-col items-center justify-center text-slate-300 dark:text-slate-600 gap-2">
                                      <div className="w-12 h-12 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center"><Icons.Plus size={20}/></div>
                                      <span className="text-xs">גרירה או הוספה</span>
                                  </div>
                              )}
                              {semCourses.map((course) => {
                                const error = checkPrerequisiteError(course, courses);
                                const blockCount = getBlockingCount(course.id, courses);
                                const highlightState = getHighlightState(course.id);

                                return (
                                  <CourseCard 
                                    key={course.id}
                                    course={course}
                                    highlightState={highlightState}
                                    error={error}
                                    blockCount={blockCount}
                                    onToggle={toggleCourseCompletion}
                                    onEdit={openEditModal}
                                    onDelete={handleDeleteCourse}
                                    onDragStart={handleDragStart}
                                    onHover={setHoveredCourse}
                                    onLeave={() => setHoveredCourse(null)}
                                    setRef={el => courseRefs.current[course.id] = el}
                                  />
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                      
                      <button onClick={() => setSemesterCount(c => c + 1)} className="w-12 h-[calc(100vh-140px)] rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-indigo-400 dark:hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 text-slate-400 dark:text-slate-600 hover:text-indigo-600 dark:hover:text-indigo-400 flex items-center justify-center transition-all">
                          <Icons.Plus size={24} />
                      </button>
                    </div>
                </div>

                {/* FOOTER STATS */}
                <div className="glass-dark glass-dark-border text-white p-3 flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <div className="flex items-center gap-6 px-4">
                        <div className="flex flex-col">
                            <span className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">התקדמות לתואר</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-xl font-bold text-emerald-400">{completedCredits}</span>
                                <span className="text-sm text-slate-400">/ {totalCredits}</span>
                            </div>
                        </div>
                        <div className="w-48 h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className="h-full bg-gradient-to-r from-emerald-500 to-emerald-300 transition-all duration-500" style={{width: `${progress}%`}}></div>
                        </div>
                    </div>
                    <div className="text-xs text-slate-500 px-4">
                        פותח ע"י סטודנטים מהטכניון &bull; BananaBread v24
                    </div>
                </div>
            </div>
        );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DegreePlanner />);
</script>
</body>
</html>
