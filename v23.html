<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BananaBread v23.0</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        html, body { height: 100%; margin: 0; padding: 0; background-color: #f8fafc; font-family: sans-serif; overflow-x: hidden; }
        
        .suggestions-anim { animation: fadeIn 0.1s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Smooth transitions for lines */
        path.connection-line { 
            fill: none; 
            stroke-width: 3px; 
            stroke-linecap: round;
            transition: stroke-opacity 0.3s, stroke 0.3s;
            pointer-events: none;
        }

        .tooltip-container:hover .tooltip-content { display: block; }
        
        /* Glassmorphism utilities */
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .glass-dark { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="root" class="h-full flex flex-col"></div>

<script type="text/babel">
    const { useState, useMemo, useEffect, useRef, useCallback } = React;

   const FACULTY_DATA = {
        "הנדסת חשמל ומחשבים": [
            { id: "electricalEngTracks.csv:Electrical Engineering", name: "הנדסת חשמל" },
            { id: "electricalEngTracks.csv:Electrical Engineering and Mathematics", name: "הנדסת חשמל ומתמטיקה" },
            { id: "electricalEngTracks.csv:Electrical and Computer Engineering", name: "הנדסת חשמל ומחשבים" },
            { id: "electricalEngTracks.csv:Electrical Engineering and Physics", name: "הנדסת חשמל ופיזיקה" },
            { id: "electricalEngTracks.csv:Combined Electrical Engineering and Physics", name: "הנדסת חשמל ופיזיקה (משולב)" },
            { id: "electricalEngTracks.csv:Computer Engineering", name: "הנדסת מחשבים" }
        ],
        "מדעי המחשב": [
            { id: "csTracks.csv:Computer Science - General Four-Year Track", name: "מדעי המחשב (כללי 4 שנתי)" },
            { id: "csTracks.csv:Computer Science and Computer Systems - Cyber Security Track", name: "סייבר ואבטחת מידע" },
            { id: "csTracks.csv:Computer Science - General Three-Year Track", name: "מדעי המחשב (כללי 3 שנתי)" },
            { id: "csTracks.csv:Computer Science - Learning and Data Analysis Track", name: "למידה וניתוח מידע" },
            { id: "csTracks.csv:Computer Science - Bioinformatics Track", name: "ביואינפורמטיקה" },
            { id: "csTracks.csv:Software Engineering Track", name: "הנדסת תוכנה" },
            { id: "csTracks.csv:Computer Engineering Track", name: "הנדסת מחשבים (מדמ\"ח)" },
            { id: "csTracks.csv:Computer Science and Mathematics - Combined Track", name: "מדעי המחשב ומתמטיקה" },
            { id: "csTracks.csv:Computer Science and Physics - Combined Track", name: "מדעי המחשב ופיזיקה" },
            { id: "csTracks.csv:Medicine and Computer Science - Double Degree Track", name: "רפואה ומדעי המחשב" }
        ],
        "הנדסת מכונות": [
            { id: "mechEngTracks.csv:Mechanical Engineering", name: "הנדסת מכונות" },
            { id: "mechEngTracks.csv:BRAKIM", name: "ברקים (מצוינות)" }
        ],
        "הנדסה אזרחית וסביבתית": [
            { id: "civilEngTracks.csv:Civil Engineering - Water & Environment", name: "הנדסה אזרחית - מים וסביבה" },
            { id: "civilEngTracks.csv:Civil Engineering - Transportation", name: "הנדסה אזרחית - תחבורה" },
            { id: "civilEngTracks.csv:Civil Engineering", name: "הנדסה אזרחית (כללי/מבנים)" },
            { id: "civilEngTracks.csv:Civil Engineering - Management and Construction", name: "ניהול ובנייה" },
            { id: "civilEngTracks.csv:Environmental Engineering", name: "הנדסת סביבה" },
            { id: "civilEngTracks.csv:Mapping and Geo-Information Engineering", name: "מיפוי וגיאו-אינפורמציה" },
            { id: "civilEngTracks.csv:Mapping and Geo-Information 3Y Engineering", name: "מיפוי וגיאו-אינפורמציה (3 שנתי)" }
        ],
        "הנדסת תעשייה וניהול": [
            { id: "dataDecisionTracks.csv:Data and Information Engineering", name: "הנדסת נתונים ומידע" },
            { id: "dataDecisionTracks.csv:Industrial Engineering and Management", name: "הנדסת תעשייה וניהול" },
            { id: "dataDecisionTracks.csv:Information Systems Engineering", name: "מערכות מידע" },
            { id: "dataDecisionTracks.csv:Medicine and Data Engineering", name: "רפואה והנדסת נתונים" }
        ],
        "הנדסת אווירונאוטיקה וחלל": [
            { id: "aerospaceTracks.csv:Aeronautics and Astronautics", name: "הנדסת אווירונאוטיקה" },
            { id: "aerospaceTracks.csv:Aeronautics and Physics", name: "אווירונאוטיקה ופיזיקה" }
        ],
        "הנדסה כימית": [
            { id: "chemicalEngTracks.csv:Chemical Engineering", name: "הנדסה כימית" },
            { id: "chemicalEngTracks.csv:Biochemical Engineering", name: "הנדסה ביוכימית" }
        ],
        "הנדסת ביוטכנולוגיה ומזון": [
            { id: "biotechFoodTracks.csv:Biotechnology and Food Engineering", name: "הנדסת ביוטכנולוגיה ומזון" }
        ],
        "הנדסה ביו-רפואית": [
            { id: "biomedicalTracks.csv:Biomedical Engineering", name: "הנדסה ביו-רפואית" },
            { id: "biomedicalTracks.csv:Biomedical Engineering and Physics", name: "ביו-רפואה ופיזיקה" },
            { id: "biomedicalTracks.csv:Medicine and Biomedical Engineering", name: "רפואה והנדסה ביו-רפואית" }
        ],
        "הנדסת חומרים": [
            { id: "materialsTracks.csv:Materials Engineering", name: "הנדסת חומרים" },
            { id: "materialsTracks.csv:Materials Engineering and Physics", name: "הנדסת חומרים ופיזיקה" },
            { id: "materialsTracks.csv:Materials Engineering and Chemistry", name: "הנדסת חומרים וכימיה" },
            { id: "materialsTracks.csv:Materials Engineering and Biology", name: "הנדסת חומרים וביולוגיה" }
        ],
        "ארכיטקטורה ובינוי ערים": [
            { id: "architectureTracks.csv:Architecture and Town Planning", name: "ארכיטקטורה" }
        ],
        "מתמטיקה": [
            { id: "mathTracks.csv:Three-year program in Mathematics", name: "מתמטיקה (3 שנתי)" },
            { id: "mathTracks.csv:Combined Mathematics-Physics", name: "מתמטיקה ופיזיקה (משולב)" },
            { id: "mathTracks.csv:Mathematics with Computer Science", name: "מתמטיקה עם מדעי המחשב" },
            { id: "mathTracks.csv:Applied Mathematics", name: "מתמטיקה שימושית" },
            { id: "mathTracks.csv:Computer Science and Mathematics", name: "מדעי המחשב ומתמטיקה" }
        ],
        "פיזיקה": [
            { id: "physicsTracks.csv:Physics - Three-Year Track", name: "פיזיקה (3 שנתי)" },
            { id: "physicsTracks.csv:Physics - Four-Year Track", name: "פיזיקה (4 שנתי)" },
            { id: "physicsTracks.csv:Mathematics and Physics - Combined Three-Year Track", name: "מתמטיקה ופיזיקה (3 שנתי)" },
            { id: "physicsTracks.csv:Physics - Electrical and Computer Engineering Track", name: "פיזיקה - מגמת הנדסת חשמל" },
            { id: "physicsTracks.csv:Physics and Electrical Engineering - Combined Track", name: "פיזיקה והנדסת חשמל (משולב)" },
            { id: "physicsTracks.csv:Computer Science and Physics - Combined Degree Track", name: "מדעי המחשב ופיזיקה (משולב)" },
            { id: "physicsTracks.csv:Biomedical Engineering and Physics - Combined Degree Track", name: "הנדסה ביו-רפואית ופיזיקה" },
            { id: "physicsTracks.csv:Aerospace Engineering and Physics - Combined Degree Track", name: "אווירונאוטיקה ופיזיקה" }
        ],
        "כימיה": [
            { id: "chemistryTracks.csv:Chemistry", name: "כימיה" },
            { id: "chemistryTracks.csv:Haznek Chemistry - Medicinal", name: "כימיה - מזנק (רפואית)" },
            { id: "chemistryTracks.csv:Haznek Chemistry - Technologies", name: "כימיה - מזנק (טכנולוגיות)" },
            { id: "chemistryTracks.csv:Haznek Chemistry - Quantum", name: "כימיה - מזנק (קוונטים)" },
            { id: "chemistryTracks.csv:Molecular Biochemistry", name: "ביוכימיה מולקולרית" }
        ],
        "ביולוגיה": [
            { id: "biologyTracks.csv:Biology", name: "ביולוגיה" },
            { id: "biologyTracks.csv:Biology - Research and Human Development", name: "ביולוגיה - מחקר והתפתחות האדם" },
            { id: "biologyTracks.csv:Biology - Microbiology Ecology and Environment", name: "ביולוגיה - מיקרוביולוגיה ואקולוגיה" },
            { id: "biologyTracks.csv:Biology - Research in Biology and Molecular Biochemistry", name: "ביולוגיה - ביוכימיה מולקולרית" },
            { id: "biologyTracks.csv:Double Major in Biology and Chemistry", name: "ביולוגיה וכימיה (דו-חוגי)" }
        ],
        "רפואה": [
            { id: "medicineTracks.csv:Medical Sciences", name: "מדעי הרפואה" },
            { id: "medicineTracks.csv:Medicine and Biomedical Engineering", name: "רפואה והנדסה ביו-רפואית" },
            { id: "medicineTracks.csv:Medicine and Computer Science - Double Degree Track", name: "רפואה ומדעי המחשב" }
        ],
        "חינוך למדע וטכנולוגיה": [
            { id: "educationTracks.csv:Mathematics Education", name: "הוראת המתמטיקה" },
            { id: "educationTracks.csv:Physics Education", name: "הוראת הפיזיקה" },
            { id: "educationTracks.csv:Chemistry Education", name: "הוראת הכימיה" },
            { id: "educationTracks.csv:Biology-Environmental Sciences Education", name: "הוראת הביולוגיה ומדעי הסביבה" },
            { id: "educationTracks.csv:Computer Science Education", name: "הוראת מדעי המחשב" },
            { id: "educationTracks.csv:Technology-Mechanical Education", name: "הוראת טכנולוגיה-מכונות" },
            { id: "educationTracks.csv:Electronics-Electricity Education", name: "הוראת חשמל ואלקטרוניקה" }
        ]
    };


    const Icons = {
        Loader: ({size=24}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
        Trash2: ({size=14}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
        Pencil: ({size=14}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
        AlertCircle: ({size=12, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
        Save: ({size=18}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
        Check: ({size=14, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className || "text-white"}><polyline points="20 6 9 17 4 12"/></svg>,
        PlusCircle: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></svg>,
        Refresh: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
        GitBranch: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></svg>,
        Info: ({size=12}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
        Eye: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
        EyeOff: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>,
        ChevronDown: ({size=16, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>,
        ChevronUp: ({size=16, className}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>,
        Download: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
        Upload: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
        Fire: ({size=12}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="none" className="text-orange-500"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3.3.9.9 1.8 1.9 2.8z"/></svg>,
        BookOpen: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        Plus: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
    };

    const normalizeId = (id) => String(id).trim();

    // DFS to find deep dependencies
    const getAllAncestors = (courseId, allCourses) => {
        const ancestors = new Set();
        try {
            const find = (cId, depth = 0) => {
                if (depth > 20) return; 
                const course = allCourses.find(c => c.id === cId);
                if (!course || !course.prereqs) return;
                course.prereqs.forEach(pId => {
                    if (!ancestors.has(pId)) { ancestors.add(pId); find(pId, depth + 1); }
                });
            };
            find(courseId);
        } catch (e) { console.warn("Ancestor finding error", e); }
        return ancestors;
    };

    // Calculate how many courses depend on this one
    const getBlockingCount = (courseId, allCourses) => {
        return allCourses.filter(c => c.prereqs && c.prereqs.includes(courseId)).length;
    };

    const checkPrerequisiteLogic = (prereqString, targetSemester, currentCourses) => {
        if (!prereqString || typeof prereqString !== 'string' || !prereqString.trim()) return true;
        try {
            const courseIds = prereqString.match(/\d{6,8}/g);
            if (!courseIds) return true;

            const completionMap = {};
            courseIds.forEach(id => {
                const normalizedId = normalizeId(id);
                const courseInBoard = currentCourses.find(c => c.id === normalizedId);
                const isCompleted = (courseInBoard && courseInBoard.completed) || (courseInBoard && courseInBoard.semester < targetSemester);
                completionMap[id] = isCompleted;
            });

            let cleanStr = prereqString
                .replace(/א[וֹ]/g, "||")
                .replace(/\sOR\s/gi, "||")
                .replace(/וגם/g, "&&")
                .replace(/\sAND\s/gi, "&&")
                .replace(/[\[\{]/g, "(")
                .replace(/[\]\}]/g, ")");

            // Sort by length desc to avoid replacing partial IDs
            const ids = Object.keys(completionMap).sort((a,b) => b.length - a.length);
            ids.forEach(id => {
                 cleanStr = cleanStr.split(id).join(completionMap[id].toString());
            });

            const safeEvalStr = cleanStr.replace(/[^truefalse\(\)\&\|!\s]/gi, "");
            const result = new Function(`return (${safeEvalStr});`)();
            return !!result;

        } catch (e) {
            // Fallback: If any prereq is done, we might be good (simplified)
            const values = Object.values(completionMap || {});
            const completedCount = values.filter(v => v === true).length;
            const requiredCount = values.length;
            if (requiredCount > 1 && completedCount > 0) return true; 
            return false;
        }
    };

    const checkPrerequisiteError = (course, allCourses) => {
        try {
            if (course.prereqString) {
                if (checkPrerequisiteLogic(course.prereqString, course.semester, allCourses)) return null;
                return "דרישות הקדם לא הושלמו";
            }
            if (!course.prereqs || !Array.isArray(course.prereqs)) return null;
            const missing = course.prereqs.filter(pid => {
                const pre = allCourses.find(c => c.id === pid);
                return !pre || (!pre.completed && pre.semester >= course.semester);
            });
            return missing.length > 0 ? "חסרים קדמים" : null;
        } catch (e) { return null; }
    };

    const getMissingDetails = (course, allCourses) => {
        const missingList = [];
        try {
             if (course.prereqs && Array.isArray(course.prereqs)) {
                 course.prereqs.forEach(pid => {
                     const pre = allCourses.find(c => c.id === pid);
                     if (!pre) missingList.push({ id: pid, reason: 'חסר בלוח' });
                     else if (!pre.completed && pre.semester >= course.semester) missingList.push({ id: pid, name: pre.name, reason: `סמסטר ${pre.semester} (חייב להיות לפני)` });
                 });
             }
             if (course.prereqString && missingList.length === 0) {
                 const courseIds = course.prereqString.match(/\d{6,8}/g) || [];
                 courseIds.forEach(id => {
                     const pre = allCourses.find(c => c.id === normalizeId(id));
                     if (!pre || (!pre.completed && pre.semester >= course.semester)) {
                         if (!missingList.find(x => x.id === id)) {
                             missingList.push({ id: id, name: pre ? pre.name : 'קורס', reason: pre ? `סמסטר ${pre.semester}` : 'חסר' });
                         }
                     }
                 });
             }
        } catch(e) {}
        return missingList;
    };

    // --- FACULTY COLORS ---
    const getFacultyColor = (id) => {
        const cleanId = String(id).replace(/^0+/, ''); 
        const prefix = cleanId.substring(0, 2);
        const baseStyle = "border-l-[4px] shadow-sm hover:shadow-md transition-all";

        switch(prefix) {
            case '23': return `${baseStyle} bg-emerald-50 border-emerald-200 border-l-emerald-600 text-emerald-900`; 
            case '10': return `${baseStyle} bg-blue-50 border-blue-200 border-l-blue-600 text-blue-900`; 
            case '11': return `${baseStyle} bg-violet-50 border-violet-200 border-l-violet-600 text-violet-900`; 
            case '04': return `${baseStyle} bg-amber-50 border-amber-200 border-l-amber-600 text-amber-900`; 
            case '09': return `${baseStyle} bg-fuchsia-50 border-fuchsia-200 border-l-fuchsia-600 text-fuchsia-900`; 
            case '01': return `${baseStyle} bg-orange-50 border-orange-200 border-l-orange-600 text-orange-900`; 
            case '08': return `${baseStyle} bg-sky-50 border-sky-200 border-l-sky-600 text-sky-900`; 
            case '12': 
            case '13': return `${baseStyle} bg-rose-50 border-rose-200 border-l-rose-600 text-rose-900`; 
            default: return `${baseStyle} bg-white border-slate-200 border-l-slate-400 text-slate-700`;
        }
    };

    const TrackSelectionModal = ({ isOpen, onClose, onSelectTrack }) => {
        if (!isOpen) return null;
        const [expandedFaculty, setExpandedFaculty] = React.useState(null);
        const toggleFaculty = (faculty) => setExpandedFaculty(expandedFaculty === faculty ? null : faculty);

        return (
            <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[80] backdrop-blur-sm p-4 animate-in fade-in">
                <div className="bg-white rounded-2xl shadow-2xl max-w-2xl w-full h-[80vh] flex flex-col border border-slate-200 overflow-hidden">
                    <div className="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center shrink-0">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                             <Icons.BookOpen size={24} className="text-indigo-600"/>
                             בחר מסלול לימודים
                        </h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold p-2 bg-slate-200/50 hover:bg-slate-200 rounded-full transition-colors w-8 h-8 flex items-center justify-center">✕</button>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scrollbar p-2 bg-slate-100">
                        <div className="space-y-2">
                        {Object.entries(FACULTY_DATA).map(([facultyName, tracks]) => {
                            const isOpen = expandedFaculty === facultyName;
                            return (
                                <div key={facultyName} className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                                    <button onClick={() => toggleFaculty(facultyName)} className={`w-full px-5 py-4 flex items-center justify-between transition-colors ${isOpen ? 'bg-indigo-50 text-indigo-700' : 'text-slate-700 hover:bg-slate-50'}`}>
                                        <span className="font-bold text-base">{facultyName}</span>
                                        {isOpen ? <Icons.ChevronUp size={20} /> : <Icons.ChevronDown size={20} className="text-slate-400" />}
                                    </button>
                                    {isOpen && (
                                        <div className="bg-slate-50 px-4 py-3 border-t border-indigo-100 shadow-inner">
                                            {tracks.length > 0 ? (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                    {tracks.map((track) => (
                                                        <button key={track.id} onClick={() => onSelectTrack(track.id)} className="text-right px-4 py-3 rounded-lg text-sm text-slate-600 hover:text-indigo-700 hover:bg-white hover:shadow-md transition-all border border-slate-200 hover:border-indigo-200 flex items-center gap-3 bg-white">
                                                            <div className="w-2 h-2 rounded-full bg-indigo-400 shrink-0"></div><span className="font-medium">{track.name}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            ) : <div className="text-center text-slate-400 text-sm py-2">(אין מסלולים זמינים)</div>}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    function DegreePlanner() {
        const [catalog, setCatalog] = useState([]); 
        const [loadingStatus, setLoadingStatus] = useState("loading");
        const [statusMessage, setStatusMessage] = useState("טוען קטלוג...");
        const [courses, setCourses] = useState([]);
        const [semesterCount, setSemesterCount] = useState(8);
        const [draggedCourse, setDraggedCourse] = useState(null);
        const [hoveredCourse, setHoveredCourse] = useState(null);
        
        // Modals state
        const [isEditing, setIsEditing] = useState(false);
        const [editingId, setEditingId] = useState(null);
        const [showPrereqSelector, setShowPrereqSelector] = useState(false);
        const [showTrackModal, setShowTrackModal] = useState(false);
        const [courseToDelete, setCourseToDelete] = useState(null);

        // Edit form state
        const [newCourseName, setNewCourseName] = useState('');
        const [newCourseCredits, setNewCourseCredits] = useState(3);
        const [newCourseSem, setNewCourseSem] = useState(1);
        const [newCoursePrereqs, setNewCoursePrereqs] = useState([]);
        const [newCourseId, setNewCourseId] = useState(null);
        const [newCourseFaculty, setNewCourseFaculty] = useState('');
        const [suggestions, setSuggestions] = useState([]);
        const [showSuggestions, setShowSuggestions] = useState(false);
        
        // Complex logic state
        const [pendingCourse, setPendingCourse] = useState(null);
        const [missingPrereqOptions, setMissingPrereqOptions] = useState([]);
        const [selectedPrereqsToAdd, setSelectedPrereqsToAdd] = useState([]);
        const [showAllConnections, setShowAllConnections] = useState(false);
        const [connections, setConnections] = useState([]);

        const wrapperRef = useRef(null);
        const courseRefs = useRef({});
        const containerRef = useRef(null);
        const fileInputRef = useRef(null);

        // --- INIT & SAVE ---
        useEffect(() => {
            const savedCourses = localStorage.getItem("technion_planner_courses_v5");
            const savedSemesters = localStorage.getItem("technion_planner_semesters_v5");
            if (savedCourses) { try { setCourses(JSON.parse(savedCourses)); } catch(e) {} }
            if (savedSemesters) setSemesterCount(parseInt(savedSemesters));
        }, []);

        useEffect(() => {
            if (courses.length > 0 || semesterCount !== 8) {
                localStorage.setItem("technion_planner_courses_v5", JSON.stringify(courses));
                localStorage.setItem("technion_planner_semesters_v5", semesterCount.toString());
            }
        }, [courses, semesterCount]);

        useEffect(() => {
            const loadData = async () => {
                const fetchCsv = (file) => new Promise((resolve, reject) => {
                    Papa.parse(file, {
                        download: true, header: true, skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: (err) => reject(err)
                    });
                });
                try {
                    const coursesRaw = await fetchCsv('courses.csv');
                    if (!coursesRaw || coursesRaw.length === 0) throw new Error("קובץ ריק");
                    const processedCatalog = coursesRaw.map(row => {
                        if (!row.id) return null;
                        return {
                            id: normalizeId(row.id), name: row.name || "ללא שם", credits: parseFloat(row.points || row.credits || 0),
                            faculty: row.faculty || "", recSem: 1, 
                            prereqs: (row.prerequisites || "").match(/\d{6,8}/g)?.map(n => normalizeId(n)) || [], 
                            prereqString: row.prerequisites || "" 
                        };
                    }).filter(Boolean);
                    setCatalog(processedCatalog);
                    setLoadingStatus("success");
                    setStatusMessage(`קטלוג: ${processedCatalog.length} קורסים`);
                } catch (err) {
                    setLoadingStatus("error");
                    setStatusMessage(`שגיאה בטעינת קטלוג. וודא שקובץ courses.csv קיים.`);
                }
            };
            loadData();
        }, []);

        // --- CONNECTIONS LOGIC (Optimized) ---
        const updateConnections = useCallback(() => {
            if (!containerRef.current) { setConnections([]); return; }
            if (!showAllConnections && !hoveredCourse) { setConnections([]); return; }
            
            // Debounce for performance inside
            requestAnimationFrame(() => {
                try {
                    const newConnections = [];
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const scrollLeft = containerRef.current.scrollLeft;
                    const scrollTop = containerRef.current.scrollTop;

                    const getCoords = (id) => {
                        const el = courseRefs.current[id];
                        if (!el) return null;
                        const rect = el.getBoundingClientRect();
                        return {
                            left: rect.left - containerRect.left + scrollLeft, 
                            right: rect.right - containerRect.left + scrollLeft,
                            centerY: (rect.top + rect.bottom) / 2 - containerRect.top + scrollTop
                        };
                    };

                    const createPath = (src, tgt) => {
                        const startX = tgt.left; const startY = tgt.centerY;
                        const endX = src.right; const endY = src.centerY;
                        const dist = Math.abs(startX - endX);
                        const controlOffset = Math.min(dist * 0.5, 80); 
                        return `M ${startX} ${startY} C ${startX - controlOffset} ${startY}, ${endX + controlOffset} ${endY}, ${endX} ${endY}`;
                    };

                    if (showAllConnections) {
                        courses.forEach(c => {
                            if (!c.prereqs || c.prereqs.length === 0) return;
                            const sourceCoords = getCoords(c.id);
                            if (!sourceCoords) return;
                            c.prereqs.forEach(pid => {
                                const prereqCourse = courses.find(pc => pc.id === pid);
                                if (prereqCourse) {
                                    const targetCoords = getCoords(pid);
                                    if (targetCoords) newConnections.push({ id: `${c.id}-${pid}`, path: createPath(sourceCoords, targetCoords), color: "#cbd5e1", opacity: 0.3, width: 2 });
                                }
                            });
                        });
                    } 
                    
                    if (hoveredCourse) {
                        const ancestors = getAllAncestors(hoveredCourse.id, courses);
                        const chainSet = new Set([...ancestors, hoveredCourse.id]);
                        
                        // Draw prereq chain
                        courses.forEach(c => {
                            if (chainSet.has(c.id) && c.prereqs) {
                                c.prereqs.forEach(pid => {
                                    if (chainSet.has(pid)) {
                                        const src = getCoords(c.id); const tgt = getCoords(pid);
                                        if (src && tgt) newConnections.push({ id: `chain-${c.id}-${pid}`, path: createPath(src, tgt), color: "#3b82f6", opacity: 0.8, width: 3 });
                                    }
                                });
                            }
                        });
                        
                        // Draw blocking arrows (what this course unlocks)
                        courses.filter(c => c.prereqs && c.prereqs.includes(hoveredCourse.id)).forEach(post => {
                            const src = getCoords(post.id); const tgt = getCoords(hoveredCourse.id);
                            if (src && tgt) newConnections.push({ id: `post-${post.id}`, path: createPath(src, tgt), color: "#f59e0b", opacity: 0.8, width: 3 });
                        });
                    }
                    setConnections(newConnections);
                } catch(e) { setConnections([]); }
            });
        }, [hoveredCourse, courses, showAllConnections]);

        useEffect(() => { updateConnections(); }, [updateConnections]);

        // --- ACTIONS ---
        const resetAllData = () => {
            if(confirm("בטוח שברצונך למחוק הכל ולהתחיל מחדש?")) {
                setCourses([]); setSemesterCount(8);
                localStorage.removeItem("technion_planner_courses_v5");
                localStorage.removeItem("technion_planner_semesters_v5");
            }
        };

        const handleExport = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({courses, semesterCount, version: "23.0"}));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "bananabread_plan.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        };

        const handleImportClick = () => fileInputRef.current.click();
        const handleImportFile = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.courses) setCourses(json.courses);
                    if(json.semesterCount) setSemesterCount(json.semesterCount);
                    alert("התוכנית נטענה בהצלחה!");
                } catch(err) { alert("שגיאה בטעינת הקובץ"); }
            };
            reader.readAsText(file);
            event.target.value = null; // reset
        };

        const handleTrackSelect = async (selectionId) => {
            if (!selectionId) return;
            const [fileName, trackName] = selectionId.split(':');
            if (courses.length > 0 && !window.confirm("טעינת מסלול תמחק את הקורסים הקיימים. להמשיך?")) return; 
            
            setLoadingStatus("loading"); setStatusMessage(`טוען מסלול ${trackName}...`); setShowTrackModal(false);
            try {
                const response = await fetch(fileName);
                if (!response.ok) throw new Error(`הקובץ ${fileName} לא נמצא`);
                Papa.parse(await response.text(), {
                    header: true, skipEmptyLines: true,
                    complete: (results) => {
                        const trackRows = results.data.filter(row => row.track_name === trackName);
                        if (trackRows.length === 0) throw new Error(`המסלול לא נמצא בקובץ`);
                        const newBoard = []; let maxSem = semesterCount;
                        trackRows.forEach(row => {
                            const cId = normalizeId(row.course_id || row.id); 
                            const semester = parseInt(row.semester || row.recommended_semester);
                            if (semester > maxSem) maxSem = semester;
                            const fullDetails = catalog.find(c => c.id === cId);
                            if (fullDetails) newBoard.push({ ...fullDetails, semester: semester, completed: false });
                            else newBoard.push({ id: cId, name: cId, credits: 0, semester: semester, completed: false });
                        });
                        if (maxSem > semesterCount) setSemesterCount(maxSem);
                        setCourses(newBoard); setLoadingStatus("success"); setStatusMessage("מסלול נטען");
                    },
                    error: (err) => { throw new Error("שגיאת CSV"); }
                });
            } catch (err) { setLoadingStatus("error"); setStatusMessage(`שגיאה: ${err.message}`); }
        };

        const toggleCourseCompletion = (courseId) => {
            setCourses(prev => prev.map(c => c.id === courseId ? { ...c, completed: !c.completed } : c));
        };

        const handleSaveCourse = () => {
            if (!newCourseName) return;
            const targetSem = parseInt(newCourseSem);
            const catalogCourse = catalog.find(c => c.id === newCourseId);
            const prereqStr = catalogCourse ? catalogCourse.prereqString : "";
            
            const courseData = {
                id: newCourseId || Math.random().toString(36).substr(2, 9),
                name: newCourseName, semester: targetSem, credits: parseFloat(newCourseCredits) || 0,
                prereqs: newCoursePrereqs || [], faculty: newCourseFaculty || '', prereqString: prereqStr, completed: false
            };

            if (editingId) {
                setCourses(prev => [...prev.filter(c => c.id !== editingId), courseData]); setIsEditing(false); return;
            }

            // Check if prereqs exist in board
            let missingIds = [];
            if (prereqStr) missingIds = (prereqStr.match(/\d{6,8}/g) || []).filter(pid => !courses.find(c => c.id === pid));
            
            if (missingIds.length > 0) {
                const options = missingIds.map(mid => {
                    const catInfo = catalog.find(c => c.id === mid);
                    return { id: mid, name: catInfo ? catInfo.name : mid };
                }).filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i);

                setPendingCourse(courseData); setMissingPrereqOptions(options); setSelectedPrereqsToAdd([]); 
                setIsEditing(false); setShowPrereqSelector(true); return;
            }

            setCourses([...courses, courseData]); setIsEditing(false);
        };

        const confirmPrereqSelection = () => {
            if (!pendingCourse) return;
            let targetCourse = { ...pendingCourse };
            let prereqSemester = Math.max(1, targetCourse.semester - 1);
            if (selectedPrereqsToAdd.length > 0 && targetCourse.semester <= 1) { targetCourse.semester = 2; prereqSemester = 1; }
            const extras = selectedPrereqsToAdd.map(pid => {
                const catInfo = catalog.find(c => c.id === pid);
                return {
                    id: pid, name: catInfo ? catInfo.name : pid, credits: catInfo ? catInfo.credits : 0,
                    faculty: catInfo ? catInfo.faculty : '', semester: prereqSemester, 
                    prereqs: catInfo ? catInfo.prereqs : [], prereqString: catInfo ? catInfo.prereqString : "", completed: false
                };
            });
            setCourses([...courses, ...extras, targetCourse]); setShowPrereqSelector(false); setPendingCourse(null);
        };

        // --- DRAG DROP ---
        const handleDragStart = (e, course) => { setDraggedCourse(course); };
        const handleDragOver = (e) => e.preventDefault();
        const handleDrop = (e, targetSemester) => { 
            e.preventDefault(); 
            if (!draggedCourse) return; 
            setCourses(prev => prev.map(c => c.id === draggedCourse.id ? { ...c, semester: targetSemester } : c)); 
            setDraggedCourse(null); 
        };

        // --- RENDER HELPERS ---
        const getHighlightClass = (courseId) => {
            const baseColor = getFacultyColor(courseId);
            if (hoveredCourse) {
                if (hoveredCourse.id === courseId) return `scale-[1.02] shadow-lg z-30 ${baseColor} ring-2 ring-indigo-400`;
                const ancestors = getAllAncestors(hoveredCourse.id, courses);
                // Dependencies (Parents)
                if (ancestors.has(courseId)) return "bg-blue-50 border-blue-400 ring-1 ring-blue-300 z-20 opacity-100";
                // Blocked by this (Children)
                if (courses.find(c => c.id === courseId)?.prereqs?.includes(hoveredCourse.id)) return "bg-amber-50 border-amber-400 ring-1 ring-amber-300 z-20 opacity-100";
                if (!showAllConnections) return "bg-white border-slate-100 opacity-30 grayscale z-10";
            }
            return baseColor;
        };

        const totalCredits = courses.reduce((acc, c) => acc + (c.credits || 0), 0);
        const completedCredits = courses.reduce((acc, c) => acc + (c.completed ? (c.credits || 0) : 0), 0);
        const progress = totalCredits > 0 ? (completedCredits / totalCredits) * 100 : 0;

        const openAddModal = (sem) => { setEditingId(null); setNewCourseName(''); setNewCourseSem(sem); setNewCourseId(null); setSuggestions([]); setIsEditing(true); };
        const openEditModal = (c) => { setEditingId(c.id); setNewCourseName(c.name); setNewCourseCredits(c.credits); setNewCourseSem(c.semester); setNewCoursePrereqs(c.prereqs||[]); setNewCourseId(c.id); setNewCourseFaculty(c.faculty); setIsEditing(true); };
        const handleNameChange = (e) => {
            const val = e.target.value; setNewCourseName(val);
            if (val.length > 1) { 
                const searchVal = normalizeId(val); 
                setSuggestions(catalog.filter(c => c.name.includes(val) || c.id.includes(searchVal)).slice(0, 10)); setShowSuggestions(true); 
            } else setShowSuggestions(false);
        };

        return (
            <div className="flex flex-col h-screen overflow-hidden bg-slate-100 font-sans">
                {/* HEADER */}
                <div className="bg-white border-b border-slate-200 shadow-sm z-40 px-6 py-3 flex justify-between items-center shrink-0">
                    <div className="flex items-center gap-4">
                        <div className="flex flex-col">
                            <h1 className="text-2xl font-black bg-gradient-to-r from-yellow-600 to-amber-700 bg-clip-text text-transparent flex items-center gap-2">
                                BananaBread <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full border">v23.0</span>
                            </h1>
                        </div>
                        <div className="h-8 w-px bg-slate-200 mx-2"></div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setShowTrackModal(true)} className="flex items-center gap-2 px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg text-sm font-bold transition-colors">
                                <Icons.BookOpen size={16}/> מסלול
                            </button>
                            <button onClick={() => setShowAllConnections(!showAllConnections)} className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-bold transition-colors border ${showAllConnections ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>
                                {showAllConnections ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>} תלות
                            </button>
                        </div>
                        {loadingStatus !== 'success' && <span className="text-xs flex items-center gap-1 bg-amber-50 text-amber-700 px-2 py-1 rounded"><Icons.Loader size={12}/> {statusMessage}</span>}
                    </div>

                    <div className="flex items-center gap-3">
                        <input type="file" ref={fileInputRef} onChange={handleImportFile} className="hidden" accept=".json" />
                        <button onClick={handleImportClick} className="text-slate-500 hover:text-indigo-600 p-2 rounded hover:bg-slate-100" title="טען תוכנית"><Icons.Upload size={18}/></button>
                        <button onClick={handleExport} className="text-slate-500 hover:text-indigo-600 p-2 rounded hover:bg-slate-100" title="שמור תוכנית"><Icons.Download size={18}/></button>
                        <div className="w-px h-6 bg-slate-200"></div>
                        <button onClick={resetAllData} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded" title="איפוס"><Icons.Refresh size={16}/></button>
                    </div>
                </div>

                {/* MODALS */}
                <TrackSelectionModal isOpen={showTrackModal} onClose={() => setShowTrackModal(false)} onSelectTrack={handleTrackSelect} />
                
                {/* PREREQ MODAL */}
                {showPrereqSelector && (
                    <div className="fixed inset-0 bg-slate-900/40 flex items-center justify-center z-[70] backdrop-blur-sm">
                        <div className="bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full animate-in zoom-in-95">
                            <div className="flex items-start gap-3 mb-4">
                                <div className="bg-amber-100 p-2 rounded-full text-amber-600"><Icons.GitBranch size={24}/></div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800">השלמת קדמים</h3>
                                    <p className="text-sm text-slate-500">הקורס <strong>{pendingCourse?.name}</strong> דורש קורסים שחסרים בלוח.</p>
                                </div>
                            </div>
                            <div className="max-h-60 overflow-y-auto custom-scrollbar border rounded-xl bg-slate-50 p-2 mb-4">
                                {missingPrereqOptions.map(opt => (
                                    <label key={opt.id} className="flex items-center gap-3 p-3 bg-white rounded-lg border border-slate-200 mb-2 hover:border-indigo-400 cursor-pointer">
                                        <input type="checkbox" className="w-5 h-5 accent-indigo-600" checked={selectedPrereqsToAdd.includes(opt.id)} onChange={() => setSelectedPrereqsToAdd(prev => prev.includes(opt.id) ? prev.filter(x => x !== opt.id) : [...prev, opt.id])} />
                                        <div><div className="font-bold text-slate-700 text-sm">{opt.name}</div><div className="text-xs text-slate-400">{opt.id}</div></div>
                                    </label>
                                ))}
                            </div>
                            <div className="flex justify-end gap-2">
                                <button onClick={() => setShowPrereqSelector(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg text-sm">ביטול</button>
                                <button onClick={confirmPrereqSelection} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold">הוסף מסומנים</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* EDIT MODAL */}
                {isEditing && (
                    <div className="fixed inset-0 bg-slate-900/30 flex items-start justify-center pt-20 z-[60] backdrop-blur-sm">
                        <div className="w-full max-w-2xl bg-white p-6 rounded-2xl shadow-2xl animate-in slide-in-from-bottom-4">
                            <h3 className="font-bold text-xl text-slate-800 mb-4">{editingId ? 'עריכת קורס' : 'הוספת קורס'}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" ref={wrapperRef}>
                                <div className="md:col-span-2 relative">
                                    <label className="text-xs font-bold text-slate-500 uppercase">שם הקורס</label>
                                    <input className="w-full border p-2 rounded-lg outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500" value={newCourseName} onChange={handleNameChange} placeholder="הקלד שם או מספר..." autoFocus />
                                    {showSuggestions && (
                                        <div className="absolute w-full bg-white border shadow-xl rounded-lg mt-1 max-h-48 overflow-y-auto z-50">
                                            {suggestions.map(s => (
                                                <button key={s.id} onClick={() => { setNewCourseName(s.name); setNewCourseCredits(s.credits); setNewCourseId(s.id); setNewCourseFaculty(s.faculty); setNewCoursePrereqs(courses.filter(c => s.prereqs.includes(c.id)).map(c=>c.id)); setShowSuggestions(false); }} className="w-full text-right px-4 py-2 hover:bg-indigo-50 border-b flex justify-between">
                                                    <span>{s.name}</span><span className="text-xs bg-slate-100 px-2 rounded">{s.id}</span>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div><label className="text-xs font-bold text-slate-500 uppercase">נקודות</label><input type="number" step="0.5" className="w-full border p-2 rounded-lg" value={newCourseCredits} onChange={e=>setNewCourseCredits(e.target.value)}/></div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase">סמסטר</label>
                                    <select className="w-full border p-2 rounded-lg" value={newCourseSem} onChange={e=>setNewCourseSem(e.target.value)}>
                                        {Array.from({length: semesterCount},(_,i)=>i+1).map(s=><option key={s} value={s}>סמסטר {s}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div className="flex justify-end gap-3 pt-4 border-t">
                                <button onClick={() => setIsEditing(false)} className="px-5 py-2 text-slate-600 hover:bg-slate-100 rounded-lg">ביטול</button>
                                <button onClick={handleSaveCourse} className="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold flex items-center gap-2"><Icons.Save size={16}/> שמור</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* MAIN BOARD */}
                <div className="flex-1 overflow-x-auto overflow-y-hidden relative custom-scrollbar bg-slate-100" ref={containerRef}>
                    <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-0" style={{minWidth: 'max-content', height: '100%'}}>
                        {connections.map((conn, i) => (
                            <path key={conn.id + i} d={conn.path} stroke={conn.color} strokeOpacity={conn.opacity} strokeWidth={conn.width || 2} className="connection-line" />
                        ))}
                    </svg>
                    
                    <div className="flex gap-4 p-4 min-w-max h-full items-start">
                      {Array.from({length: semesterCount}, (_, i) => i + 1).map((semNum) => {
                        const semCourses = courses.filter(c => c.semester === semNum);
                        const semCredits = semCourses.reduce((sum, c) => sum + (c.credits || 0), 0);
                        
                        return (
                          <div key={semNum} onDragOver={handleDragOver} onDrop={(e) => handleDrop(e, semNum)} className="w-80 flex flex-col h-[calc(100vh-140px)] rounded-2xl border border-slate-200 bg-white shadow-sm transition-colors hover:border-indigo-300 z-10">
                            {/* Semester Header */}
                            <div className={`p-3 border-b border-slate-100 rounded-t-2xl flex justify-between items-center ${semCredits > 27 ? 'bg-red-50' : 'bg-slate-50'}`}>
                              <div>
                                  <h2 className="font-bold text-slate-700">סמסטר {semNum}</h2>
                                  <div className={`text-xs font-bold ${semCredits > 27 ? 'text-red-600' : 'text-slate-400'}`}>{semCredits} נק'</div>
                              </div>
                              <button onClick={() => openAddModal(semNum)} className="text-slate-400 hover:text-indigo-600 p-1.5 hover:bg-white rounded-full transition-colors"><Icons.PlusCircle size={20}/></button>
                            </div>

                            {/* Course List */}
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar bg-slate-50/50">
                              {semCourses.length === 0 && (
                                  <div className="h-full flex flex-col items-center justify-center text-slate-300 gap-2">
                                      <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center"><Icons.Plus size={20}/></div>
                                      <span className="text-xs">גרירה או הוספה</span>
                                  </div>
                              )}
                              {semCourses.map((course) => {
                                const error = checkPrerequisiteError(course, courses);
                                const missingDetails = error ? getMissingDetails(course, courses) : [];
                                const isCompleted = course.completed;
                                const blockCount = getBlockingCount(course.id, courses);

                                return (
                                  <div 
                                    key={course.id}
                                    ref={el => courseRefs.current[course.id] = el}
                                    draggable 
                                    onDragStart={(e) => handleDragStart(e, course)} 
                                    onMouseEnter={() => setHoveredCourse(course)} 
                                    onMouseLeave={() => setHoveredCourse(null)} 
                                    className={`relative p-3 rounded-xl border select-none group transition-transform duration-200
                                        ${getHighlightClass(course.id)} 
                                        ${error && !isCompleted ? '!border-red-400 !bg-red-50' : ''}
                                        ${isCompleted ? '!bg-green-50 !border-green-400' : ''} 
                                    `}
                                  >
                                    <div className="flex justify-between items-start gap-2">
                                      <div className="flex-1 min-w-0">
                                          <h4 className={`font-bold text-sm text-slate-800 leading-tight truncate ${isCompleted ? 'line-through opacity-60' : ''}`} title={course.name}>{course.name}</h4>
                                          <div className="flex items-center gap-2 mt-1">
                                              <span className="text-[10px] bg-slate-100 px-1.5 rounded text-slate-500 font-mono">{course.id}</span>
                                              <span className="text-[10px] text-blue-600 font-bold">{course.credits} נק'</span>
                                              {blockCount > 2 && <div className="flex items-center gap-0.5 text-[10px] text-orange-600 font-bold bg-orange-100 px-1.5 rounded-full" title={`חוסם ${blockCount} קורסים בהמשך (נתיב קריטי)`}><Icons.Fire size={10}/> {blockCount}</div>}
                                          </div>
                                      </div>
                                      <div className="flex flex-col gap-1">
                                        <button onClick={() => toggleCourseCompletion(course.id)} className={`w-5 h-5 rounded-full border flex items-center justify-center transition-colors ${isCompleted ? 'bg-green-500 border-green-600' : 'border-slate-300 hover:border-indigo-400'}`}>
                                            {isCompleted && <Icons.Check size={10} />}
                                        </button>
                                      </div>
                                    </div>
                                    
                                    {/* Edit/Delete Overlay */}
                                    <div className="absolute top-2 left-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity bg-white/80 p-1 rounded shadow-sm backdrop-blur-sm">
                                        <button onClick={() => openEditModal(course)} className="text-slate-500 hover:text-indigo-600"><Icons.Pencil size={12}/></button>
                                        <button onClick={() => { if(confirm("למחוק?")) setCourses(p=>p.filter(x=>x.id!==course.id)); }} className="text-slate-500 hover:text-red-600"><Icons.Trash2 size={12}/></button>
                                    </div>

                                    {/* Error Display */}
                                    {error && !isCompleted && (
                                      <div className="mt-2 text-[10px] text-red-600 bg-red-100/50 px-2 py-1 rounded border border-red-200 flex items-center gap-1">
                                          <Icons.AlertCircle size={10} /> 
                                          <span className="truncate">{error}</span>
                                      </div>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                      
                      <button onClick={() => setSemesterCount(c => c + 1)} className="w-12 h-[calc(100vh-140px)] rounded-2xl border-2 border-dashed border-slate-300 hover:border-indigo-400 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 flex items-center justify-center transition-all">
                          <Icons.Plus size={24} />
                      </button>
                    </div>
                </div>

                {/* FOOTER STATS */}
                <div className="glass-dark text-white p-3 flex justify-between items-center z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                    <div className="flex items-center gap-6 px-4">
                        <div className="flex flex-col">
                            <span className="text-[10px] text-slate-400 uppercase tracking-wider font-bold">התקדמות לתואר</span>
                            <div className="flex items-baseline gap-1">
                                <span className="text-xl font-bold text-emerald-400">{completedCredits}</span>
                                <span className="text-sm text-slate-400">/ {totalCredits}</span>
                            </div>
                        </div>
                        <div className="w-48 h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className="h-full bg-gradient-to-r from-emerald-500 to-emerald-300 transition-all duration-500" style={{width: `${progress}%`}}></div>
                        </div>
                    </div>
                    <div className="text-xs text-slate-500 px-4">
                        פותח ע"י סטודנטים מהטכניון &bull; BananaBread v23.0
                    </div>
                </div>
            </div>
        );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<DegreePlanner />);
</script>
</body>
</html>
